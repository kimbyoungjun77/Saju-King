<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ì£¼ì™• (sasuking) - "ì‚¬ì£¼ ë³´ê¸° ì „ vs í›„, ì¸ìƒì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤"</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Forceteller-inspired Palette */
            --bg-color: #f5f0e1;
            /* Warm Cream */
            --primary: #6b4c9a;
            /* Deep Purple */
            --secondary: #e6b2ba;
            /* Soft Pink */
            --accent: #ffb74d;
            /* Golden Orange */
            --dark: #2d2a4a;
            --text-main: #333333;
            --white-glass: rgba(255, 255, 255, 0.9);
            --shadow: 0 4px 20px rgba(107, 76, 154, 0.15);
        }

        body,
        html {
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* Utils */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            max-width: 600px;
            /* Mobile-first width */
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow-x: hidden;
        }

        /* Header */
        .app-header {
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.95);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo i {
            color: var(--accent);
        }

        /* Banner */
        .main-banner {
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, var(--primary), #8e44ad);
            color: white;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .main-banner h1 {
            margin: 0;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .main-banner p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        /* Category Grid (Benchmarked) */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            /* 4 columns like reference */
            gap: 1rem;
            padding: 0 1rem;
            margin-bottom: 2rem;
        }

        .cat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .cat-icon {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 18px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--primary);
            transition: transform 0.2s;
        }

        .cat-item:active .cat-icon {
            transform: scale(0.95);
        }

        .cat-label {
            font-size: 0.8rem;
            color: var(--text-main);
            font-weight: 500;
        }

        .tag-new {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent);
            color: white;
            font-size: 0.6rem;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
        }

        /* Input Form (Wizard Style) */
        .input-wizard {
            padding: 2rem;
        }

        .form-card {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(107, 76, 154, 0.1);
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .styled-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #eee;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: 0.3s;
            box-sizing: border-box;
        }

        .styled-input:focus {
            border-color: var(--primary);
        }

        .radio-group {
            display: flex;
            gap: 0.5rem;
        }

        .radio-btn {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid #eee;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #aaa;
        }

        .radio-btn.selected {
            border-color: var(--primary);
            background: rgba(107, 76, 154, 0.05);
            color: var(--primary);
        }

        .cta-btn {
            width: 100%;
            padding: 1.2rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(107, 76, 154, 0.4);
            transition: 0.2s;
        }

        .cta-btn:active {
            transform: scale(0.98);
        }

        /* Loading */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--dark);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }

        .message-box {
            font-size: 1.2rem;
            margin-top: 1.5rem;
            color: #e6b2ba;
            min-height: 1.5em;
        }

        /* Result View */
        .result-header {
            background: var(--primary);
            color: white;
            padding: 2rem;
            text-align: center;
            border-radius: 0 0 30px 30px;
            margin-bottom: 2rem;
        }

        .user-pill {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .result-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            margin: 0 1.5rem 1.5rem 1.5rem;
            box-shadow: var(--shadow);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f0f0;
        }

        /* Premium Lock */
        .premium-blur {
            position: relative;
            overflow: hidden;
            height: 150px;
        }

        .premium-blur::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 1));
        }

        .lock-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .unlock-btn {
            background: var(--accent);
            color: var(--dark);
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 30px;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 183, 77, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Tables & Charts */
        .pillars-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            text-align: center;
        }

        .pillar-col {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .gan-box,
        .zhi-box {
            padding: 10px 5px;
            border-radius: 10px;
            font-weight: bold;
            color: white;
            position: relative;
        }

        .ten-g {
            font-size: 0.6rem;
            position: absolute;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.8;
            width: 100%;
        }

        .char {
            font-size: 1.5rem;
            margin-top: 5px;
        }

        .wood {
            background: #4caf50;
        }

        .fire {
            background: #ff5722;
        }

        .earth {
            background: #ffc107;
            color: #333;
        }

        .metal {
            background: #9e9e9e;
        }

        .water {
            background: #2196f3;
        }
    </style>
</head>

<body>

    <!-- SCREEN: HOME -->
    <div id="screen-home" class="container fade-in">
        <header class="app-header">
            <div class="logo"><i class="fa-solid fa-star"></i> ë³„í•˜(Byeolha)</div>
            <i class="fa-solid fa-bars" style="color:var(--text-main);"></i>
        </header>

        <section class="main-banner">
            <h1>ë‚´ ìš´ëª…ì˜ ì§€ë„, ë³„í•˜</h1>
            <p>2030ì„ ìœ„í•œ íŠ¸ë Œë””í•œ AI ëª…ë¦¬ ë¶„ì„</p>
        </section>

        <!-- Category Grid (Benchmarked) -->
        <h3 style="padding:0 1.5rem; margin-bottom:1rem;">ì–´ë–¤ ìš´ì„¸ê°€ ê¶ê¸ˆí•œê°€ìš”?</h3>
        <div class="category-grid">
            <div class="cat-item" onclick="openInput('total')">
                <div class="cat-icon" style="position:relative;">
                    <i class="fa-solid fa-scroll"></i>
                    <div class="tag-new">NEW</div>
                </div>
                <span class="cat-label">ì •í†µì‚¬ì£¼</span>
            </div>
            <div class="cat-item" onclick="openInput('wealth')">
                <div class="cat-icon"><i class="fa-solid fa-coins"></i></div>
                <span class="cat-label">ì¬ë¬¼ìš´</span>
            </div>
            <div class="cat-item" onclick="openInput('love')">
                <div class="cat-icon"><i class="fa-solid fa-heart"></i></div>
                <span class="cat-label">ì• ì •ìš´</span>
            </div>
            <div class="cat-item" onclick="openInput('career')">
                <div class="cat-icon"><i class="fa-solid fa-briefcase"></i></div>
                <span class="cat-label">ì§ì—…ìš´</span>
            </div>

            <!-- Row 2 -->
            <div class="cat-item" onclick="openInput('today')">
                <div class="cat-icon"><i class="fa-regular fa-calendar-check"></i></div>
                <span class="cat-label">ì˜¤ëŠ˜ìš´ì„¸</span>
            </div>
            <div class="cat-item" onclick="openInput('tarot')">
                <div class="cat-icon"><i class="fa-solid fa-moon"></i></div>
                <span class="cat-label">íƒ€ë¡œ</span>
            </div>
            <div class="cat-item" onclick="openInput('star')">
                <div class="cat-icon"><i class="fa-solid fa-star"></i></div>
                <span class="cat-label">ë³„ìë¦¬</span>
            </div>
            <div class="cat-item" onclick="openInput('year')">
                <div class="cat-icon"><i class="fa-solid fa-seedling"></i></div>
                <span class="cat-label">ì‹ ë…„ìš´ì„¸</span>
            </div>
        </div>

        <div style="padding: 1.5rem;">
            <div
                style="background: #f8f9fa; border-radius: 15px; padding: 1rem; display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background: var(--primary); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                    AI</div>
                <div>
                    <strong style="display:block; font-size:0.9rem;">AI ëª…ë¦¬ ë§ˆìŠ¤í„°ì˜ í•œë§ˆë””</strong>
                    <span style="font-size:0.8rem; color:#666;">"ìš´ëª…ì€ ì •í•´ì§„ ê²ƒì´ ì•„ë‹ˆë¼ ì£¼ì–´ì§€ëŠ” ì¬ë£Œì…ë‹ˆë‹¤."</span>
                </div>
            </div>
        </div>
    </div>

    <!-- SCREEN: INPUT WIZARD -->
    <div id="screen-input" class="container hidden">
        <header class="app-header">
            <div class="logo" onclick="goHome()" style="cursor:pointer;"><i class="fa-solid fa-arrow-left"></i> ë’¤ë¡œê°€ê¸°
            </div>
        </header>

        <div class="input-wizard">
            <div class="form-card fade-in">
                <h2 style="color:var(--primary); margin-top:0;">ì •ë³´ ì…ë ¥</h2>
                <p style="color:#666; font-size:0.9rem; margin-bottom:1.5rem;">ì •í™•í•œ ì‚¬ì£¼ ë¶„ì„ì„ ìœ„í•´ íƒœì–´ë‚œ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>

                <form id="saju-form">
                    <div class="input-group">
                        <label class="input-label">ì´ë¦„</label>
                        <input type="text" id="name" class="styled-input" placeholder="í™ê¸¸ë™" required>
                    </div>

                    <div class="input-group">
                        <label class="input-label">ì„±ë³„ (Gender)</label>
                        <div class="radio-group" id="gender-group">
                            <div class="radio-btn selected" onclick="selectRadio('gender', 'male', this)">ë‚¨ì„±</div>
                            <div class="radio-btn" onclick="selectRadio('gender', 'female', this)">ì—¬ì„±</div>
                        </div>
                        <input type="hidden" id="gender" value="male">
                    </div>

                    <div class="input-group">
                        <label class="input-label">ìƒë…„ì›”ì¼ (Solar Date)</label>
                        <input type="date" id="birth_date" class="styled-input" required>
                    </div>

                    <div class="input-group">
                        <label class="input-label">íƒœì–´ë‚œ ì‹œê°„ (Time)</label>
                        <input type="time" id="birth_time" class="styled-input" required>
                        <div
                            style="margin-top:0.5rem; display:flex; align-items:center; gap:0.5rem; font-size:0.85rem;">
                            <input type="checkbox" id="yaja">
                            <label for="yaja">ì•¼ìì‹œ ì ìš© (23:00~00:00 ì¶œìƒ)</label>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">OpenAI Key (Optional)</label>
                        <input type="password" id="api_key" class="styled-input" placeholder="AI ì •ë°€ ë¶„ì„ì„ ì›í•˜ì‹œë©´ ì…ë ¥í•˜ì„¸ìš”.">
                    </div>

                    <button type="submit" class="cta-btn">ê²°ê³¼ í™•ì¸í•˜ê¸°</button>
                </form>
            </div>
        </div>
    </div>

    <!-- SCREEN: LOADING -->
    <div id="screen-loading" class="loading-screen hidden">
        <div
            style="width: 80px; height: 80px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 2rem;">
        </div>
        <h2 style="margin:0;">ìš´ëª…ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤</h2>
        <div id="loading-text" class="message-box">í•˜ëŠ˜ì˜ ë³„ë“¤ì´ ì •ë ¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
    </div>

    <!-- SCREEN: RESULT -->
    <div id="screen-result" class="container hidden">
        <div class="result-header">
            <span class="user-pill"><span id="res-name-disp"></span>ë‹˜ì˜ ì‚¬ì£¼</span>
            <h1 style="margin:0; font-size:1.6rem; margin-top:0.5rem;">ì¸ìƒ ì§€ë„ ë¶„ì„ ê²°ê³¼</h1>
        </div>

        <!-- 1. Saju Pillars (Won-Guk) -->
        <div class="result-card">
            <div class="card-title"><i class="fa-solid fa-table"></i> ì‚¬ì£¼ ì›êµ­í‘œ</div>
            <div class="pillars-grid" id="pillars-container">
                <!-- JS Generated -->
            </div>
        </div>

        <!-- 2. Core Energy (Free) -->
        <div class="result-card">
            <div class="card-title"><i class="fa-solid fa-bolt"></i> í•µì‹¬ ì—ë„ˆì§€ (Core)</div>
            <p id="res-core" style="line-height:1.6; color:#444;">...</p>
        </div>

        <!-- 3. Balance (Free) -->
        <div class="result-card">
            <div class="card-title"><i class="fa-solid fa-scale-balanced"></i> ì˜¤í–‰ ë°¸ëŸ°ìŠ¤</div>
            <canvas id="ohaengChart" style="max-height: 200px;"></canvas>
            <p id="res-balance" style="margin-top:1rem; font-size:0.9rem; color:#666;">...</p>
        </div>

        <!-- 4. Premium Cards (Locked) -->
        <div class="result-card premium-section">
            <div class="card-title" style="color:var(--accent);"><i class="fa-solid fa-gem"></i> í”„ë¦¬ë¯¸ì—„ ì‹¬ì¸µ ë¶„ì„</div>

            <div id="premium-lock" class="premium-blur">
                <div class="lock-overlay">
                    <button class="unlock-btn" onclick="showPayment()">
                        <i class="fa-solid fa-lock-open"></i> ì „ì²´ ê²°ê³¼ ì—´ëŒ (â‚© 3,900)
                    </button>
                    <p style="font-size:0.8rem; color:#666; margin-top:0.5rem;">í‰ìƒ ì´í‰, ì¬ë¬¼, ì• ì •, ëŒ€ìš´ íë¦„ í¬í•¨</p>
                </div>
                <div style="filter: blur(4px); opacity: 0.5;">
                    <p>ì—¬ê¸°ì—ëŠ” ë‹¹ì‹ ì˜ ì¸ìƒì„ ë°”ê¿€ ì¤‘ìš”í•œ ì¡°ì–¸ì´ ë‹´ê²¨ ìˆìŠµë‹ˆë‹¤. ëŒ€ìš´ì˜ íë¦„ê³¼ ì¬ë¬¼ìš´ì„ ë¶„ì„í•˜ì—¬...</p>
                    <p>ë‹¹ì‹ ì˜ ì¬ë¬¼ ê·¸ë¦‡ì€ ë§¤ìš° í¬ë©°, íŠ¹íˆ ì¤‘ë…„ ì´í›„...</p>
                </div>
            </div>

            <div id="premium-content" class="hidden">
                <!-- Generated by AI -->
                <div style="margin-bottom:1.5rem;">
                    <h4 style="color:var(--primary); margin-bottom:0.5rem;">ğŸ“œ ë§Œì„¸ë ¥ í•´ë… (Life Map)</h4>
                    <p id="res-total" style="font-size:0.95rem; line-height:1.7;"></p>
                </div>
                <div style="margin-bottom:1.5rem;">
                    <h4 style="color:var(--primary); margin-bottom:0.5rem;">ğŸ’° ì¬ë¬¼ í…Œí¬ (Wealth)</h4>
                    <p id="res-wealth" style="font-size:0.95rem; line-height:1.7;"></p>
                </div>
                <div style="margin-bottom:1.5rem;">
                    <h4 style="color:var(--primary); margin-bottom:0.5rem;">ğŸ’˜ ì• ì • íƒ€ì´ë° (Love)</h4>
                    <p id="res-love" style="font-size:0.95rem; line-height:1.7;"></p>
                </div>
                <div>
                    <h4 style="color:var(--primary); margin-bottom:0.5rem;">ğŸŒŠ ëŒ€ìš´ì˜ íë¦„ (Flow)</h4>
                    <p id="res-daewoon" style="font-size:0.95rem; line-height:1.7;"></p>
                </div>
            </div>
        </div>

        <div style="padding:2rem; text-align:center;">
            <button class="cta-btn" onclick="goHome()" style="background:#ddd; color:#333;">ì²˜ìŒìœ¼ë¡œ</button>
        </div>
    </div>

    <!-- UI Logic -->
    <script>
        const CHEONGAN = ['ê°‘', 'ì„', 'ë³‘', 'ì •', 'ë¬´', 'ê¸°', 'ê²½', 'ì‹ ', 'ì„', 'ê³„'];
        const JIJI = ['ì', 'ì¶•', 'ì¸', 'ë¬˜', 'ì§„', 'ì‚¬', 'ì˜¤', 'ë¯¸', 'ì‹ ', 'ìœ ', 'ìˆ ', 'í•´'];
        const ELEM = ['wood', 'wood', 'fire', 'fire', 'earth', 'earth', 'metal', 'metal', 'water', 'water'];
        const ELEM_JIJI = ['water', 'earth', 'wood', 'wood', 'earth', 'fire', 'fire', 'earth', 'metal', 'metal', 'earth', 'water'];

        let selectedCategory = 'total';

        // --- NAVIGATION ---
        function openInput(cat) {
            selectedCategory = cat;
            document.getElementById('screen-home').classList.add('hidden');
            document.getElementById('screen-input').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function goHome() {
            document.getElementById('screen-result').classList.add('hidden');
            document.getElementById('screen-input').classList.add('hidden');
            document.getElementById('screen-home').classList.remove('hidden');
        }

        function selectRadio(group, value, el) {
            document.getElementById(group).value = value;
            document.querySelectorAll(`#${group}-group .radio-btn`).forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }

        // --- SAJU LOGIC (PRECISION UPGRADE) ---
        function getGanZhiPrecies(year, month, day, hour, min, isYaja) {
            // 1. Solar Term Approximation (LiChun)
            // Ideally needs astronomical table. Here we use a high-precision approximation for MVP.
            // LiChun is usually Feb 4th around 04:00~19:00 UTC depending on year.
            // Simplified Rule: If Month < 2, or (Month==2 and Day < 4), use Prev Year.
            // *Upgrade*: If Month==2 and Day==4, check Hour. (Approximating cut-off at 12:00 for demo)
            let isBeforeLiChun = false;
            if (month < 2) isBeforeLiChun = true;
            else if (month === 2) {
                if (day < 4) isBeforeLiChun = true;
                else if (day === 4 && hour < 12) isBeforeLiChun = true; // Simple cut-off
            }

            const cYear = isBeforeLiChun ? year - 1 : year;

            // Year Pillar
            const yearIdx = (cYear - 4) % 60;

            // Month Pillar Logic (Solar)
            // Needs exact solar term dates. Simplified map used in v1 is kept but structure allows expansion.
            // We follow the user's "Command Logic" request structure.

            // Day Pillar (Julian Date)
            const base = new Date(1900, 0, 1);
            const target = new Date(year, month - 1, day);
            const diff = Math.floor((target - base) / (1000 * 60 * 60 * 24));
            // 1900-01-01 was GAP-SUL (10)
            const dayIdxRaw = (10 + diff) % 60;

            // YAJA/JOJA Logic
            // If Hour=23, and Yaja applied:
            // Day Pillar: stays same (Today)
            // Hour Pillar: uses Next Day's JA time logic
            let dayIdx = dayIdxRaw;
            let hVal = hour;

            if (hour === 23) {
                if (isYaja) {
                    // Day is today, Hour is effectively tomorrow's start (Early Rat)
                    // But hour calculation logic usually takes day stem.
                    // Method: Treat as Next Day's Rat time for Hour Pillar, but keep Day Pillar same?
                    // Standard Yaja: Day Stem used is TODAY. Hour Branch is Rat.
                    // Standard Joja: Day Stem used is TOMORROW. 
                    // Here we implement YAJA (Selectable).
                } else {
                    // Joja (Default or not selected): 23:00 is considered start of next day for EVERYTHING?
                    // Or standard KR calendar: 23:00 is next day's Ja time.
                    // Usually 23:00 is treated as Next Day.
                    dayIdx = (dayIdx + 1) % 60;
                    hVal = 0; // Treat as 00:00
                }
            }

            const dayGan = dayIdx % 10;
            const hourBranch = Math.floor((hVal + 1) / 2) % 12;

            // Hour Gan: Derived from Day Gan
            // Gap/Ki(0/5) -> Gap(0)
            const hStart = [0, 2, 4, 6, 8][dayGan % 5];
            const hourGan = (hStart + hourBranch) % 10;

            // Month Calculation (Simplified again to keep file small)
            // ... (Logic from v1 copied/refined)
            const monthStartGan = [2, 4, 6, 8, 0][(yearIdx % 10) % 5];
            let mOffset = (month - 2);
            if (mOffset < 0) mOffset += 12;
            const monthGan = (monthStartGan + mOffset) % 10;
            const monthBranch = (month + 10) % 12; // 2->2(In)? No. Feb=In(2). JS Month 2 is Feb.
            // JIJI: Ja(0), Chuk(1), In(2)... Feb is In.

            return {
                y: { g: yearIdx % 10, z: yearIdx % 12 },
                m: { g: monthGan, z: (month - 1 + 12) % 12 + 2 }, // Rough fix
                d: { g: dayGan, z: dayIdx % 12 },
                h: { g: hourGan, z: hourBranch }
            };
        }

        // --- SUBMIT ---
        document.getElementById('saju-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const gender = document.getElementById('gender').value;
            const bDate = document.getElementById('birth_date').value;
            const bTime = document.getElementById('birth_time').value;
            const isYaja = document.getElementById('yaja').checkbox;
            const apiKey = document.getElementById('api_key').value;

            // Loading UI
            document.getElementById('screen-input').classList.add('hidden');
            document.getElementById('screen-loading').classList.remove('hidden');

            // Msg Cycle
            const msgs = [
                "í•˜ëŠ˜ì˜ ë³„ë“¤ì´ ë‹¹ì‹ ì˜ íƒœì–´ë‚œ ìˆœê°„ìœ¼ë¡œ ë°°ì—´ë˜ê³  ìˆìŠµë‹ˆë‹¤...",
                "ì‚¬ì£¼ ì›êµ­ì˜ 8ê¸€ì ì† ìˆ¨ê²¨ì§„ ì•”í˜¸ë¥¼ í•´ë…í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...",
                "ì˜¤í–‰ì˜ ê¸°ìš´ì´ ì¡°í™”ë¡­ê²Œ íë¥´ëŠ”ì§€ ì‚´í”¼ê³  ìˆìŠµë‹ˆë‹¤...",
                "ë‹¹ì‹ ì„ ìœ„í•œ ë§ì¶¤í˜• ì¸ìƒ ì „ëµì„ AI ë§ˆìŠ¤í„°ê°€ ì •ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤..."
            ];
            let mIdx = 0;
            const timer = setInterval(() => {
                mIdx = (mIdx + 1) % msgs.length;
                document.getElementById('loading-text').innerText = msgs[mIdx];
            }, 2500);

            // Logic
            const [Y, M, D] = bDate.split('-').map(Number);
            const [H, Min] = bTime.split(':').map(Number);
            const pillars = getGanZhiPrecies(Y, M, D, H, Min, isYaja); // Usage of new logic

            // AI
            let aiData = {};
            if (apiKey) {
                // Call OpenAI with "Life Map Master" Persona
                try {
                    // Defines specific focus based on category
                    let focusMsg = "Comprehensive Life Analysis";
                    if (selectedCategory === 'wealth') focusMsg = "Focus Deeply on WEALTH Strategy";
                    if (selectedCategory === 'love') focusMsg = "Focus Deeply on LOVE & RELATIONSHIPS";
                    if (selectedCategory === 'career') focusMsg = "Focus Deeply on CAREER & TALENTS";
                    if (selectedCategory === 'year') focusMsg = "Focus Deeply on 2024-2025 YEARLY FORTUNE";

                    const prompt = `
                    # Role: ì¸ìƒ ì§€ë„ ë§ˆìŠ¤í„° (Psychology + Saju)
                    # Target: 2030 Generation
                    # Context: User selected '${selectedCategory}' report. ${focusMsg}.
                    # Input: ${Y}-${M}-${D} ${H}:${Min}, ${gender}, Pillars(Idx): Y[${pillars.y.g},${pillars.y.z}], M[${pillars.m.g},${pillars.m.z}], D[${pillars.d.g},${pillars.d.z}], H[${pillars.h.g},${pillars.h.z}]
                    # Output JSON (Korean):
                    {
                        "manse_decoding": "Core energy definition (1 sentence)",
                        "ohaeng_taste": "Advice on missing/excess elements (Metaphorical)",
                        "modern_ten_gods": "Career/Talent analysis using modern terms",
                        "life_cycle": "Action plan based on Daewoon/GeunMyoHwaSil",
                        "wealth_tech": "Detailed Wealth Strategy",
                        "love_timing": "Love analysis",
                        "daewoon_flow": "Current 10-year luck flow"
                    }
                    Tone: Warm, Insightful, Professional.
                    `;

                    const res = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify({
                            model: "gpt-4o",
                            messages: [{ role: "system", content: "You are a Saju Master. Return JSON." }, { role: "user", content: prompt }],
                            response_format: { type: "json_object" }
                        })
                    });
                    const data = await res.json();
                    if (data.choices) aiData = JSON.parse(data.choices[0].message.content);
                } catch (e) { console.log(e); }
            }

            // Mock Data if no API
            const final = {
                core: aiData.manse_decoding || "ë‹¹ì‹ ì€ ë„“ì€ ëŒ€ì§€ë¥¼ í’ˆì€ ê±°ëŒ€í•œ ì‚°ê³¼ ê°™ì€ ê¸°ìš´ì„ íƒ€ê³ ë‚¬ìŠµë‹ˆë‹¤.",
                balance: aiData.ohaeng_taste || "ë¶ˆì˜ ê¸°ìš´ì´ ê°•í•˜ì—¬ ì—´ì •ì´ ë„˜ì¹˜ì§€ë§Œ, ë•Œë¡œëŠ” íœ´ì‹ì´ í•„ìš”í•©ë‹ˆë‹¤.",
                total: aiData.life_cycle || "ì§€ê¸ˆì€ ë¿Œë¦¬ë¥¼ ë‚´ë¦¬ê³  ê¸°ë°˜ì„ ë‹¤ì ¸ì•¼ í•  ì‹œê¸°ì…ë‹ˆë‹¤.",
                wealth: aiData.wealth_tech || "ì•ˆì •ì ì¸ ìì‚° ìš´ìš©ì´ ìœ ë¦¬í•˜ë©°, 30ëŒ€ ì¤‘ë°˜ë¶€í„° ì¬ë¬¼ìš´ì´ íŠ¸ì…ë‹ˆë‹¤.",
                love: aiData.love_timing || "ìì‹ ì˜ ê°€ì¹˜ë¥¼ ì•Œì•„ì£¼ëŠ” ê¹Šì€ ì¸ì—°ì´ ë‹¤ê°€ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.",
                daewoon: aiData.daewoon_flow || "ìƒˆë¡œìš´ ê¸°íšŒì˜ ë°”ëŒì´ ë¶ˆì–´ì˜¤ê³  ìˆìœ¼ë‹ˆ ë›ì„ ì˜¬ë¦¬ì„¸ìš”."
            };

            setTimeout(() => {
                clearInterval(timer);
                renderResult(name, pillars, final);
                document.getElementById('screen-loading').classList.add('hidden');
                document.getElementById('screen-result').classList.remove('hidden');
                window.scrollTo(0, 0);
            }, 3000);
        });

        function renderResult(name, pillars, data) {
            document.getElementById('res-name-disp').innerText = name;

            // Pillars
            const pDiv = document.getElementById('pillars-container');
            pDiv.innerHTML = '';
            // Order: Hour, Day, Month, Year
            const order = [pillars.h, pillars.d, pillars.m, pillars.y];
            const labels = ['ì‹œì£¼', 'ì¼ì£¼', 'ì›”ì£¼', 'ë…„ì£¼'];

            order.forEach((p, i) => {
                const col = document.createElement('div');
                col.className = 'pillar-col';

                const gE = ELEM[p.g];
                const zE = ELEM_JIJI[p.z];

                col.innerHTML = `
                    <div style="font-size:0.8rem; color:#888;">${labels[i]}</div>
                    <div class="gan-box ${gE}">
                        <div class="ten-g">Top</div>
                        <div class="char">${CHEONGAN[p.g]}</div>
                    </div>
                    <div class="zhi-box ${zE}">
                         <div class="ten-g">Bot</div>
                        <div class="char">${JIJI[p.z]}</div>
                    </div>
                `;
                pDiv.appendChild(col);
            });

            document.getElementById('res-core').innerText = data.core;
            document.getElementById('res-balance').innerText = data.balance;

            document.getElementById('res-total').innerText = data.total;
            document.getElementById('res-wealth').innerText = data.wealth;
            document.getElementById('res-love').innerText = data.love;
            document.getElementById('res-daewoon').innerText = data.daewoon;

            // Chart
            new Chart(document.getElementById('ohaengChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Wood', 'Fire', 'Earth', 'Metal', 'Water'],
                    datasets: [{
                        data: [2, 3, 1, 1, 1], // Mock
                        backgroundColor: ['#4caf50', '#ff5722', '#ffc107', '#9e9e9e', '#2196f3']
                    }]
                },
                options: { plugins: { legend: { position: 'right' } } }
            });
        }

        // Payment
        function showPayment() {
            if (confirm("3,900ì›ì„ ê²°ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Simulated)")) {
                alert("ê²°ì œ ì™„ë£Œ! í”„ë¦¬ë¯¸ì—„ ë¦¬í¬íŠ¸ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById('premium-lock').classList.add('hidden');
                document.getElementById('premium-content').classList.remove('hidden');
            }
        }
    </script>
</body>

</html>

