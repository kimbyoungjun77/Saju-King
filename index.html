<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³„í•˜ (Byeolha) - ë‹¹ì‹ ì˜ ìš´ëª…ì„ ë¹„ì¶”ë‹¤</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS MERGED from style.css */
        :root {
            --bg-color: #fdfbf7;
            --card-bg: rgba(255, 255, 255, 0.65);
            --card-border: rgba(255, 255, 255, 0.8);
            --text-main: #333333;
            --text-muted: #666666;
            --primary: #a78bfa;
            --accent: #f472b6;
            --glass-shadow: 0 8px 32px 0 rgba(74, 58, 237, 0.1);
        }

        body,
        html {
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
        }

        .text-gradient {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            box-shadow: var(--glass-shadow);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="password"] {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
        }

        .btn-primary {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(167, 139, 250, 0.3);
        }

        .saju-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
            text-align: center;
        }

        .saju-table th {
            padding: 1rem;
            color: var(--text-muted);
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .saju-table td {
            padding: 1.5rem 0.5rem;
        }

        .hanja {
            display: block;
            font-size: 2rem;
            font-weight: bold;
            font-family: 'serif';
            margin-bottom: 0.5rem;
        }

        .ten-god {
            font-size: 0.85rem;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.5);
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            display: inline-block;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .tabs button {
            padding: 0.8rem 1.5rem;
            background: white;
            border: 1px solid transparent;
            border-radius: 30px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tabs button.active {
            background: var(--text-main);
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .wood {
            color: #16a34a !important;
        }

        .fire {
            color: #ea580c !important;
        }

        .earth {
            color: #d97706 !important;
        }

        .metal {
            color: #475569 !important;
        }

        .water {
            color: #2563eb !important;
        }

        .payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .payment-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Helpers for Views */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        .mystic-spinner {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto 2rem auto;
        }

        .mystic-spinner::before,
        .mystic-spinner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: #a78bfa;
            animation: spin 2s linear infinite;
        }

        .mystic-spinner::after {
            border-top-color: #f472b6;
            animation: spin 3s linear infinite reverse;
            transform: scale(0.7);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <!-- VIEW 1: INDEX -->
    <div id="view-index" class="container view-section active"
        style="display:flex; align-items:center; justify-content:center; min-height:100vh;">
        <div class="glass-card fade-in" style="width: 100%; max-width: 480px; text-align: center;">
            <div style="margin-bottom: 2rem;">
                <i class="fa-solid fa-moon text-gradient" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <h1 class="text-gradient" style="margin: 0;">ë³„í•˜ (Byeolha)</h1>
                <p style="color: var(--text-muted); margin-top: 0.5rem;">ë‹¹ì‹ ì˜ ìš´ëª…ì„ ë¹„ì¶”ëŠ” ë³„</p>
            </div>

            <form id="saju-form" style="text-align: left;">
                <div class="form-group">
                    <label for="name">ì´ë¦„</label>
                    <input type="text" id="name" required placeholder="í™ê¸¸ë™">
                </div>

                <div class="form-group">
                    <label>ì„±ë³„</label>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                        <label
                            style="flex: 1; padding: 0.8rem; border: 1px solid #e2e8f0; border-radius: 10px; text-align: center; cursor: pointer; background: rgba(255,255,255,0.5);">
                            <input type="radio" name="gender" value="male" checked> ë‚¨ì„±
                        </label>
                        <label
                            style="flex: 1; padding: 0.8rem; border: 1px solid #e2e8f0; border-radius: 10px; text-align: center; cursor: pointer; background: rgba(255,255,255,0.5);">
                            <input type="radio" name="gender" value="female"> ì—¬ì„±
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="birth_date">ìƒë…„ì›”ì¼ (ì–‘ë ¥)</label>
                    <input type="date" id="birth_date" required>
                </div>

                <div class="form-group">
                    <label for="birth_time">íƒœì–´ë‚œ ì‹œê°„</label>
                    <input type="time" id="birth_time" required>
                </div>

                <div class="form-group">
                    <label for="api_key">OpenAI API í‚¤ (ì„ íƒì‚¬í•­, AI ë¶„ì„ìš©)</label>
                    <input type="password" id="api_key" placeholder="sk-..." style="font-size:0.8rem;">
                    <p style="font-size: 0.7rem; color: #aaa; margin-top: 0.2rem;">* í‚¤ë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ ìš´ì„¸ ë°ì´í„°ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>

                <button type="submit" class="btn-primary">
                    <i class="fa-solid fa-sparkles"></i> ë¬´ë£Œ ìš´ì„¸ í™•ì¸í•˜ê¸°
                </button>
            </form>
        </div>
    </div>

    <!-- VIEW 2: LOADING -->
    <div id="view-loading" class="view-section"
        style="background: #0f172a; position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; color:white; text-align:center; display:none; flex-direction:column; justify-content:center; align-items:center;">
        <div class="mystic-spinner"></div>
        <div id="loading-msg" class="loading-text"
            style="font-size: 1.5rem; font-weight: bold; background: linear-gradient(90deg, #a78bfa, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            í•˜ëŠ˜ì˜ ë³„ì„ ì½ê³  ìˆìŠµë‹ˆë‹¤...</div>
        <div class="sub-text" style="margin-top: 1rem; color: #94a3b8;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
    </div>

    <!-- VIEW 3: RESULT -->
    <div id="view-result" class="container view-section" style="display:none;">
        <header style="text-align: center; margin-bottom: 2rem;">
            <a href="#" onclick="location.reload()" style="text-decoration: none;">
                <h3 class="text-gradient" style="margin: 0; font-size: 1.2rem;">ë³„í•˜ (Byeolha)</h3>
            </a>
            <h1 style="margin: 0.5rem 0;"><span id="res-name"></span>ë‹˜ì˜ ìš´ëª… ë¶„ì„ ê²°ê³¼</h1>
            <p style="color: var(--text-muted);">ìƒë…„ì›”ì¼ ê¸°ë°˜ ì •ë°€ ë¶„ì„ ë¦¬í¬íŠ¸</p>
        </header>

        <!-- Saju Table -->
        <div class="glass-card">
            <h3 style="margin-top: 0;"><i class="fa-solid fa-table"></i> ì‚¬ì£¼ ì›êµ­ (Four Pillars)</h3>
            <table class="saju-table">
                <thead>
                    <tr>
                        <th style="width:10%">êµ¬ë¶„</th>
                        <th style="width:22.5%">ì‹œì£¼ (Hour)</th>
                        <th style="width:22.5%">ì¼ì£¼ (Day)</th>
                        <th style="width:22.5%">ì›”ì£¼ (Month)</th>
                        <th style="width:22.5%">ë…„ì£¼ (Year)</th>
                    </tr>
                </thead>
                <tbody id="pillars-body">
                    <!-- Rendered by JS -->
                </tbody>
            </table>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab(event, 'basic')">ê¸°ë³¸ í•´ì„</button>
            <button class="tab-btn" onclick="openTab(event, 'saju-plus')">ì˜¤í–‰ & ì‹­ì„±</button>
            <button class="tab-btn" id="premium-tab-btn" onclick="openTab(event, 'premium')"><i class="fa-solid fa-lock"
                    style="font-size: 0.8em; margin-right: 5px;"></i> ì‹¬ì¸µ ì •ë°€ ë¶„ì„ (ìœ ë£Œ)</button>
        </div>

        <!-- Tab Content -->
        <div id="basic" class="tab-content active">
            <div class="glass-card">
                <h3><i class="fa-solid fa-user-circle"></i> í•µì‹¬ ì„±í–¥</h3>
                <p id="res-core" style="line-height: 1.6;">...</p>
            </div>
            <div class="glass-card">
                <h3><i class="fa-solid fa-calendar-day"></i> ì˜¤ëŠ˜ì˜ ìš´ì„¸</h3>
                <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 10px;">
                    <strong id="res-today-date"></strong><br>
                    <p id="res-today-desc" style="margin-top: 0.5rem;">...</p>
                </div>
            </div>
        </div>

        <div id="saju-plus" class="tab-content">
            <div class="dashboard-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="glass-card">
                    <h3 style="text-align: center;">ì˜¤í–‰ ê· í˜•</h3>
                    <canvas id="ohaengChart"></canvas>
                </div>
                <div class="glass-card" style="display: flex; flex-direction: column; justify-content: center;">
                    <h3>ğŸ’¡ ë°¸ëŸ°ìŠ¤ ë¶„ì„</h3>
                    <p id="res-balance">...</p>
                </div>
            </div>
        </div>

        <div id="premium" class="tab-content">
            <!-- Locked -->
            <div id="premium-lock" class="glass-card" style="text-align: center; padding: 4rem 2rem;">
                <i class="fa-solid fa-lock" style="font-size: 4rem; color: var(--primary); margin-bottom: 1.5rem;"></i>
                <h2>ì „ì²´ ë¶„ì„ ì ê¸ˆ í•´ì œ</h2>
                <p style="color: var(--text-muted); margin-bottom: 2rem;">ì§€ê¸ˆ ê²°ì œí•˜ê³  AI ì´ˆì •ë°€ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                <button class="btn-primary" style="max-width: 300px;" onclick="showPayment()">
                    <i class="fa-regular fa-credit-card"></i> 3,900ì›ìœ¼ë¡œ ì „ì²´ ê²°ê³¼ ë³´ê¸°
                </button>
            </div>
            <!-- Unlocked -->
            <div id="premium-content" style="display: none;">
                <div class="glass-card" style="border-left: 5px solid var(--primary);">
                    <h3><i class="fa-solid fa-crown"></i> í‰ìƒ ì´í‰</h3>
                    <p id="res-total" style="white-space: pre-wrap; line-height: 1.8;">...</p>
                </div>
                <div class="glass-card">
                    <h3><i class="fa-solid fa-seedling"></i> ì¸ìƒì˜ íë¦„ (ê·¼ë¬˜í™”ì‹¤)</h3>
                    <div id="res-gmhs" class="timeline"></div>
                </div>
                <div class="glass-card">
                    <h3><i class="fa-solid fa-coins"></i> ì¬ë¬¼ & ì• ì • ì „ëµ</h3>
                    <h4>ì¬ë¬¼ìš´</h4>
                    <p id="res-wealth"></p>
                    <hr style="border: 0; border-top: 1px solid rgba(0,0,0,0.1); margin: 1.5rem 0;">
                    <h4>ì• ì •ìš´</h4>
                    <p id="res-love"></p>
                </div>
                <div class="glass-card">
                    <h3><i class="fa-solid fa-chart-line"></i> ëŒ€ìš´ íë¦„</h3>
                    <p id="res-daewoon"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="payment-modal">
        <div class="payment-content">
            <h3>ê²°ì œ ì§„í–‰ (ì‹œë®¬ë ˆì´ì…˜)</h3>
            <div style="margin: 2rem 0;">
                <div
                    style="padding: 1rem; border: 1px solid #ddd; border-radius: 10px; display: flex; align-items: center;">
                    <i class="fa-brands fa-cc-visa" style="font-size: 2rem; margin-right: 1rem; color: #1a1f71;"></i>
                    <div style="text-align: left;"><strong>Credit Card</strong><br><span
                            style="color:#888; font-size:0.9rem;">**** 1234</span></div>
                </div>
            </div>
            <button class="btn-primary" onclick="processPayment()">ê²°ì œ ìŠ¹ì¸ (â‚©3,900)</button>
            <button
                style="background:none; border:none; color:#888; text-decoration:underline; margin-top:1rem; cursor:pointer;"
                onclick="closePayment()">ì·¨ì†Œ</button>
        </div>
    </div>

    <script>
        // --- SAJU LOGIC (JS PORT) ---
        const CHEONGAN = ['ê°‘', 'ì„', 'ë³‘', 'ì •', 'ë¬´', 'ê¸°', 'ê²½', 'ì‹ ', 'ì„', 'ê³„'];
        const JIJI = ['ì', 'ì¶•', 'ì¸', 'ë¬˜', 'ì§„', 'ì‚¬', 'ì˜¤', 'ë¯¸', 'ì‹ ', 'ìœ ', 'ìˆ ', 'í•´'];
        const STEM_OHAENG = ['wood', 'wood', 'fire', 'fire', 'earth', 'earth', 'metal', 'metal', 'water', 'water'];
        const BRANCH_OHAENG = ['water', 'earth', 'wood', 'wood', 'earth', 'fire', 'fire', 'earth', 'metal', 'metal', 'earth', 'water'];

        function getGanZhi(year, month, day, hour) {
            // Simplified Solar Calculation
            const isBeforeLichun = (month < 2) || (month === 2 && day < 4);
            const calcYear = isBeforeLichun ? year - 1 : year;

            const yearIdx = (calcYear - 4) % 60;
            const yearGanIdx = yearIdx % 10;
            const yearZhiIdx = yearIdx % 12;

            const monthStartMap = { 0: 2, 5: 2, 1: 4, 6: 4, 2: 6, 7: 6, 3: 8, 8: 8, 4: 0, 9: 0 };
            const monthStartGan = monthStartMap[yearGanIdx];
            let targetMonth = day < 6 ? (month - 1) : month;
            if (targetMonth < 1) targetMonth = 12;

            const monthZhiMap = { 2: 2, 3: 3, 4: 4, 5: 5, 6: 6, 7: 7, 8: 8, 9: 9, 10: 10, 11: 11, 12: 0, 1: 1 };
            const monthZhiIdx = monthZhiMap[targetMonth] !== undefined ? monthZhiMap[targetMonth] : ((targetMonth + 1) % 12); // Fallback

            let monthOffset = targetMonth - 2;
            if (monthOffset < 0) monthOffset += 12;
            const monthGanIdx = (monthStartGan + monthOffset) % 10;

            const baseDate = new Date(2000, 0, 1); // 2000-01-01
            const targetDate = new Date(year, month - 1, day);
            const diffTime = Math.abs(targetDate - baseDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            // Note: JS Date math is tricky due to leap seconds/DST, but for demo simpler is ok. 
            // Actually direction matters.
            const delta = (targetDate - baseDate) / (1000 * 60 * 60 * 24);
            const baseCycleIdx = 54; // WuWu
            let dayCycleIdx = (baseCycleIdx + Math.floor(delta)) % 60;
            if (dayCycleIdx < 0) dayCycleIdx += 60;

            const dayGanIdx = dayCycleIdx % 10;
            const dayZhiIdx = dayCycleIdx % 12;

            const hourZhiIdx = Math.floor((hour + 1) / 2) % 12;
            const hourStartMap = { 0: 0, 5: 0, 1: 2, 6: 2, 2: 4, 7: 4, 3: 6, 8: 6, 4: 8, 9: 8 };
            const hourStartGan = hourStartMap[dayGanIdx];
            const hourGanIdx = (hourStartGan + hourZhiIdx) % 10;

            return {
                year: { gan: CHEONGAN[yearGanIdx], zhi: JIJI[yearZhiIdx], gan_idx: yearGanIdx, zhi_idx: yearZhiIdx, gan_element: STEM_OHAENG[yearGanIdx], zhi_element: BRANCH_OHAENG[yearZhiIdx] },
                month: { gan: CHEONGAN[monthGanIdx], zhi: JIJI[monthZhiIdx], gan_idx: monthGanIdx, zhi_idx: monthZhiIdx, gan_element: STEM_OHAENG[monthGanIdx], zhi_element: BRANCH_OHAENG[monthZhiIdx] },
                day: { gan: CHEONGAN[dayGanIdx], zhi: JIJI[dayZhiIdx], gan_idx: dayGanIdx, zhi_idx: dayZhiIdx, gan_element: STEM_OHAENG[dayGanIdx], zhi_element: BRANCH_OHAENG[dayZhiIdx] },
                hour: { gan: CHEONGAN[hourGanIdx], zhi: JIJI[hourZhiIdx], gan_idx: hourGanIdx, zhi_idx: hourZhiIdx, gan_element: STEM_OHAENG[hourGanIdx], zhi_element: BRANCH_OHAENG[hourZhiIdx] }
            };
        }

        function getOhaengDist(pillars) {
            let dist = { wood: 0, fire: 0, earth: 0, metal: 0, water: 0 };
            ['year', 'month', 'day', 'hour'].forEach(k => {
                dist[pillars[k].gan_element]++;
                dist[pillars[k].zhi_element]++;
            });
            return dist;
        }

        function determineGod(meIdx, targetIdx, mePol, targetPol) {
            const meElem = Math.floor(meIdx / 2);
            const tElem = Math.floor(targetIdx / 2); // Only valid for Gan indices
            // Logic requires Element index (0-4), not Gan index / 2 exactly?
            // Gan: 0,1=Wood; 2,3=Fire... Yes /2 works.
            const diff = (tElem - meElem + 5) % 5;
            const samePol = mePol === targetPol;

            if (diff === 0) return samePol ? 'ë¹„ê²¬' : 'ê²ì¬';
            if (diff === 1) return samePol ? 'ì‹ì‹ ' : 'ìƒê´€';
            if (diff === 2) return samePol ? 'í¸ì¬' : 'ì •ì¬';
            if (diff === 3) return samePol ? 'í¸ê´€' : 'ì •ê´€';
            if (diff === 4) return samePol ? 'í¸ì¸' : 'ì •ì¸';
            return '?';
        }

        function interpret(pillars) {
            const meIdx = pillars.day.gan_idx;
            const mePol = meIdx % 2;
            const gods = {};

            ['year', 'month', 'day', 'hour'].forEach(k => {
                // Gan
                const gIdx = pillars[k].gan_idx;
                gods[k] = { gan: determineGod(meIdx, gIdx, mePol, gIdx % 2) };

                // Zhi (approximation map)
                const zIdx = pillars[k].zhi_idx;
                const zToG = { 0: 9, 1: 5, 2: 0, 3: 1, 4: 4, 5: 2, 6: 3, 7: 5, 8: 6, 9: 7, 10: 4, 11: 8 };
                const zPol = { 0: 1, 1: 1, 2: 0, 3: 1, 4: 0, 5: 0, 6: 1, 7: 1, 8: 0, 9: 1, 10: 0, 11: 0 }; // Derived from Saju Logic Step
                gods[k].zhi = determineGod(meIdx, zToG[zIdx], mePol, zPol[zIdx]);
            });
            gods.day.gan = 'ë³¸ì›';
            return gods;
        }

        // --- APP CONTROLLER ---
        document.getElementById('saju-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const birthDate = document.getElementById('birth_date').value;
            const birthTime = document.getElementById('birth_time').value;
            const gender = document.querySelector('input[name="gender"]:checked').value;
            const apiKey = document.getElementById('api_key').value;

            // Switch to Loading
            document.getElementById('view-index').style.display = 'none';
            document.getElementById('view-loading').style.display = 'flex';

            // Loading Animation
            const msgs = ["í•˜ëŠ˜ì˜ ë³„ì„ ì½ê³  ìˆìŠµë‹ˆë‹¤...", "ì‚¬ì£¼ ì›êµ­ì„ í•´ë… ì¤‘ì…ë‹ˆë‹¤...", "ì¸ìƒ ì§€ë„ë¥¼ ê·¸ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤..."];
            let mIdx = 0;
            const interval = setInterval(() => {
                mIdx = (mIdx + 1) % msgs.length;
                document.getElementById('loading-msg').innerText = msgs[mIdx];
            }, 1500);

            // Calculations
            const [y, m, d] = birthDate.split('-').map(Number);
            const [th, tm] = birthTime.split(':').map(Number);

            const pillars = getGanZhi(y, m, d, th);
            const ohaeng = getOhaengDist(pillars);
            const gods = interpret(pillars);

            // AI Fetch (if key provided)
            let aiRes = null;
            if (apiKey && apiKey.startsWith('sk-')) {
                try {
                    const prompt = `
                    Analyze Saju for: ${name}, ${gender}, ${y}-${m}-${d}.
                    Pillars: Y:${pillars.year.gan}${pillars.year.zhi}, M:${pillars.month.gan}${pillars.month.zhi}, D:${pillars.day.gan}${pillars.day.zhi}, H:${pillars.hour.gan}${pillars.hour.zhi}.
                    Return JSON: {total_summary, wealth_strategy, love_romance, daewoon_trend, gmhs:{year,month,day,hour}, today_luck, balance_text}.
                    Language: Korean. Tone: Warm, Mystical.
                    `;

                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify({
                            model: "gpt-4o",
                            messages: [
                                { role: "system", content: "You are a Saju Master. Return valid JSON only." },
                                { role: "user", content: prompt }
                            ],
                            response_format: { type: "json_object" }
                        })
                    });
                    const data = await response.json();
                    if (data.choices) aiRes = JSON.parse(data.choices[0].message.content);
                } catch (err) { console.error(err); }
            }

            // Defaults
            const defText = "ìƒì„¸ ë¶„ì„ ë°ì´í„°ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. (AI í‚¤ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ í…ìŠ¤íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤)";
            const finalData = {
                core: CHEONGAN[pillars.day.gan_idx] + "ì¼ê°„ì˜ ì„±í–¥: ê°•ì¸í•¨ê³¼ ë¶€ë“œëŸ¬ì›€ì„ ê²¸ë¹„í–ˆìŠµë‹ˆë‹¤.",
                balance: aiRes?.balance_text || "ì˜¤í–‰ì˜ íë¦„ì´ ê³ ìœ ì˜ íŠ¹ì„±ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.",
                total: aiRes?.total_summary || defText,
                wealth: aiRes?.wealth_strategy || "ê¾¸ì¤€í•œ ë…¸ë ¥ì´ ê²°ì‹¤ì„ ë§ºìŠµë‹ˆë‹¤.",
                love: aiRes?.love_romance || "ì§„ì‹¤ëœ ë§ˆìŒì´ í†µí•˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤.",
                daewoon: aiRes?.daewoon_trend || "ëŒ€ìš´ì˜ íë¦„ì´ ìƒìŠ¹ ê³¡ì„ ì„ ê·¸ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.",
                gmhs: aiRes?.gmhs || { year: "ì´ˆë…„ìš´...", month: "ì²­ë…„ìš´...", day: "ì¤‘ë…„ìš´...", hour: "ë§ë…„ìš´..." },
                today: aiRes?.today_luck || "ì¢‹ì€ ì¼ì´ ìƒê¸¸ ì§•ì¡°ì…ë‹ˆë‹¤."
            };

            setTimeout(() => {
                clearInterval(interval);
                renderResult(name, pillars, gods, ohaeng, finalData);
                document.getElementById('view-loading').style.display = 'none';
                document.getElementById('view-result').style.display = 'block';
            }, 2000);
        });

        function renderResult(name, pillars, gods, ohaeng, data) {
            document.getElementById('res-name').innerText = name;

            // Render Table
            const tbody = document.getElementById('pillars-body');
            tbody.innerHTML = `
                <tr>
                    <td style="font-weight:bold;">ì²œê°„</td>
                    <td class="${pillars.hour.gan_element}"><span class="hanja">${pillars.hour.gan}</span><div class="ten-god">${gods.hour.gan}</div></td>
                    <td class="${pillars.day.gan_element}" style="background:rgba(167,139,250,0.1);"><span class="hanja">${pillars.day.gan}</span><div class="ten-god">ë‚˜</div></td>
                    <td class="${pillars.month.gan_element}"><span class="hanja">${pillars.month.gan}</span><div class="ten-god">${gods.month.gan}</div></td>
                    <td class="${pillars.year.gan_element}"><span class="hanja">${pillars.year.gan}</span><div class="ten-god">${gods.year.gan}</div></td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">ì§€ì§€</td>
                    <td class="${pillars.hour.zhi_element}"><span class="hanja">${pillars.hour.zhi}</span><div class="ten-god">${gods.hour.zhi}</div></td>
                    <td class="${pillars.day.zhi_element}"><span class="hanja">${pillars.day.zhi}</span><div class="ten-god">${gods.day.zhi}</div></td>
                    <td class="${pillars.month.zhi_element}"><span class="hanja">${pillars.month.zhi}</span><div class="ten-god">${gods.month.zhi}</div></td>
                    <td class="${pillars.year.zhi_element}"><span class="hanja">${pillars.year.zhi}</span><div class="ten-god">${gods.year.zhi}</div></td>
                </tr>
            `;

            // Fill Data
            document.getElementById('res-core').innerText = data.core;
            document.getElementById('res-today-date').innerText = new Date().toLocaleDateString();
            document.getElementById('res-today-desc').innerText = data.today;

            document.getElementById('res-balance').innerText = data.balance;
            document.getElementById('res-total').innerText = data.total;
            document.getElementById('res-wealth').innerText = data.wealth;
            document.getElementById('res-love').innerText = data.love;
            document.getElementById('res-daewoon').innerText = data.daewoon;

            // GMHS
            const gmhsDiv = document.getElementById('res-gmhs');
            gmhsDiv.innerHTML = '';
            ['year', 'month', 'day', 'hour'].forEach(p => {
                if (data.gmhs[p]) {
                    const d = document.createElement('div');
                    d.style.marginBottom = '1rem';
                    d.innerHTML = `<strong style="color:var(--primary)">${p.toUpperCase()} Use</strong><p>${data.gmhs[p]}</p>`;
                    gmhsDiv.appendChild(d);
                }
            });

            // Chart
            const ctx = document.getElementById('ohaengChart');
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ëª©', 'í™”', 'í† ', 'ê¸ˆ', 'ìˆ˜'],
                    datasets: [{
                        label: 'ì˜¤í–‰',
                        data: [ohaeng.wood, ohaeng.fire, ohaeng.earth, ohaeng.metal, ohaeng.water],
                        backgroundColor: 'rgba(167, 139, 250, 0.4)',
                        borderColor: '#a78bfa',
                        pointBackgroundColor: '#fff'
                    }]
                },
                options: { scales: { r: { suggestedMin: 0, suggestedMax: 5, ticks: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }

        // --- UI UTILS ---
        function openTab(evt, name) {
            document.querySelectorAll('.tab-content').forEach(el => { el.style.display = 'none'; el.classList.remove('active'); });
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(name).style.display = 'block';
            document.getElementById(name).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        let isPaid = false;
        function showPayment() {
            if (isPaid) return;
            document.getElementById('paymentModal').style.display = 'flex';
        }
        function closePayment() {
            document.getElementById('paymentModal').style.display = 'none';
        }
        function processPayment() {
            const btn = document.querySelector('#paymentModal .btn-primary');
            btn.innerHTML = 'ì²˜ë¦¬ ì¤‘...';
            setTimeout(() => {
                isPaid = true;
                closePayment();
                alert('ê²°ì œ ì™„ë£Œ! ì ê¸ˆ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.getElementById('premium-lock').style.display = 'none';
                document.getElementById('premium-content').style.display = 'block';
                document.getElementById('premium-tab-btn').innerHTML = '<i class="fa-solid fa-check"></i> ì‹¬ì¸µ ì •ë°€ ë¶„ì„ (ì†Œì¥ì¤‘)';
            }, 1000);
        }
    </script>
</body>

</html>
